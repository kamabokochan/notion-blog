
## **useCallback**


> `useCallback` ã¯ã€å†ãƒ¬ãƒ³ãƒ€ãƒ¼é–“ã§é–¢æ•°å®šç¾©ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ React ãƒ•ãƒƒã‚¯ã§ã™ã€‚


```typescript
const cachedFn = useCallback(fn, dependencies)
```

- fn
	- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„é–¢æ•°å‹ã®å€¤
	- ä»»æ„ã®å¼•æ•°ã‚’å–ã‚Šã€ä»»æ„ã®å€¤ã‚’è¿”ã™ã“ã¨ãŒã§ãã‚‹
	- åˆå›ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã«ã¯ã€é–¢æ•°ã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆå‘¼ã³å‡ºã•ãªã„ï¼‰
		- æ¬¡å›ä»¥é™ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã¯ã€ã²ã¨ã¤å‰ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰`dependencies` ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€å†ã³åŒã˜é–¢æ•°ã‚’è¿”ã™ã€‚
- dependencies
	- `fn` ã‚³ãƒ¼ãƒ‰å†…ã§å‚ç…§ã•ã‚Œã‚‹ã™ã¹ã¦ã®ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå€¤ã®ãƒªã‚¹ãƒˆ
		- ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå€¤ã«ã¯ã€propsã€stateã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæœ¬ä½“ã«ç›´æ¥å®£è¨€ã•ã‚ŒãŸã™ã¹ã¦ã®å¤‰æ•°ãŠã‚ˆã³é–¢æ•°ãŒå«ã¾ã‚Œã‚‹
- è¿”ã‚Šå€¤
	- åˆå›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã€`useCallback` ã¯æ¸¡ã•ã‚ŒãŸ `fn` é–¢æ•°ã‚’è¿”ã™
	- ãã®å¾Œã®ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã«ã¯ã€å‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã™ã§ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ `fn` é–¢æ•°ã‚’è¿”ã™ã‹ï¼ˆä¾å­˜é…åˆ—ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰ã€ã“ã®ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã«æ¸¡ã•ã‚ŒãŸ `fn` é–¢æ•°ã‚’è¿”ã™ã€‚

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ï¼ˆ[https://ja.react.dev/reference/react/useCallback](https://ja.react.dev/reference/react/useCallback)ï¼‰

- `handleSubmit` ã‚’`ShippingForm` ã®propsã«æ¸¡ã—ã¦ã„ã‚‹ã€‚

> **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå†ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚Œã‚‹ã¨ã€React ã¯ãã®å­è¦ç´ ã™ã¹ã¦ã‚’å†å¸°çš„ã«å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã—ã¾ã™**ã€‚


ã¾ãŸ


> **JavaScript ã§ã¯ã€****`function () {}`** **ã¾ãŸã¯** **`() => {}`** **ã¯å¸¸ã«**_**ç•°ãªã‚‹**_**é–¢æ•°ã‚’ä½œæˆã—ã¾ã™**ã€‚


ãƒ¬ãƒ³ãƒ€ãƒ¼ã™ã‚‹åº¦ã«æ–°ã—ã„é–¢æ•°`handleSubmit` ã‚’ç”Ÿæˆã™ã‚‹ã€‚


`handleSubmit` ã‚’propsã¨ã—ã¦å—ã‘å–ã£ã¦ã„ã‚‹å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ`ShippingForm` ã‚‚ã€æ¯å›å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã€‚


```typescript
function ProductPage({ productId, referrer, theme }) {
  // Every time the theme changes, this will be a different function...
  function handleSubmit(orderDetails) {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }
  
  return (
    <div className={theme}>
      {/* ... so ShippingForm's props will never be the same, and it will re-render every time */}
      <ShippingForm onSubmit={handleSubmit} />
    </div>
  );
}
```

- `handleSubmit`ã‚’`useCallback` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€`dependencies` å†…ã®å€¤ãŒå¤‰æ›´ã•ã‚Œãªã„é™ã‚Šã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸé–¢æ•°ã‚’è¿”ã™ï¼ˆå‰å›ã®ãƒ¬ãƒ³ãƒ€ãƒ¼æ™‚ã¨åŒæ§˜ã®é–¢æ•°ã‚’è¿”ã™ï¼‰
	- ä½™è¨ˆãª `ShippingForm` ã®å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

```typescript
function ProductPage({ productId, referrer, theme }) {
  // Tell React to cache your function between re-renders...
  const handleSubmit = useCallback((orderDetails) => {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }, [productId, referrer]); // ...so as long as these dependencies don't change...

  return (
    <div className={theme}>
      {/* ...ShippingForm will receive the same props and can skip re-rendering */}
      <ShippingForm onSubmit={handleSubmit} />
    </div>
  );
}
```


## **useCallback ã¨ useMemo ã®é–¢ä¿‚ï¼ˆ**[https://ja.react.dev/reference/react/useCallback#how-is-usecallback-related-to-usememo](https://ja.react.dev/reference/react/useCallback#how-is-usecallback-related-to-usememo)**ï¼‰**


> ãã®é•ã„ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãã‚‹_å†…å®¹_ã§ã™ã€‚

- `useMemo`Â ã¯ã€é–¢æ•°ã®å‘¼ã³å‡ºã—çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
- `useCallback`Â ã¯é–¢æ•°è‡ªä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹

```typescript
import { useMemo, useCallback } from 'react';

function ProductPage({ productId, referrer }) {
  const product = useData('/product/' + productId);

	// ğŸ™† useMemoã¯ã€computeRequirementsé–¢æ•°ã®å®Ÿè¡Œçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
  const requirements = useMemo(() => { // Calls your function and caches its result
    return computeRequirements(product);
  }, [product]);

	// ğŸ™† useCallbackã¯handleSubmitã¨ã„ã†é–¢æ•°è‡ªä½“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
  const handleSubmit = useCallback((orderDetails) => { // Caches your function itself
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }, [productId, referrer]);

  return (
    <div className={theme}>
      <ShippingForm requirements={requirements} onSubmit={handleSubmit} />
    </div>
  );
}
```


ç°¡ç•¥çš„ã«æ›¸ãã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢ä¿‚ã«ãªã‚‹ã€‚


```typescript
// Simplified implementation (inside React)
function useCallback(fn, dependencies) {
  return useMemo(() => fn, dependencies);
}
```


## **ã‚ã‚‰ã‚†ã‚‹å ´æ‰€ã« useCallback ã‚’è¿½åŠ ã™ã¹ãã‹ï¼Ÿï¼ˆ**[https://ja.react.dev/reference/react/useCallback#should-you-add-usecallback-everywhere](https://ja.react.dev/reference/react/useCallback#should-you-add-usecallback-everywhere)**ï¼‰**


`useCallback` ã§é–¢æ•°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ãŒæœ‰ç”¨ãªã‚±ãƒ¼ã‚¹

- é–¢æ•°ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« props ã¨ã—ã¦æ¸¡ã™ã‚±ãƒ¼ã‚¹
- é–¢æ•°ãŒã€å¾Œã§ä½•ã‚‰ã‹ã®ãƒ•ãƒƒã‚¯ã®ä¾å­˜å€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹
	- ä»–ã®Â `useCallback`Â ã§ãƒ©ãƒƒãƒ—ã•ã‚ŒãŸé–¢æ•°ãŒãã‚Œã«ä¾å­˜ã—ã¦ã„ã‚‹ã€ã¾ãŸã¯Â [`useEffect`](https://ja.react.dev/reference/react/useEffect)Â ã‹ã‚‰ã“ã®é–¢æ•°ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹

ã“ã‚Œã‚‰ã®ã‚±ãƒ¼ã‚¹ä»¥å¤–ã§ã¯ã€é–¢æ•°ã‚’`useCallback` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆã¯ãªã„ã€‚


å…¨ã¦ã®é–¢æ•°ã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã¨ã€å¯èª­æ€§ãŒä¸‹ãŒã‚‹ã€‚


é–¢é€£ï¼š 


## **ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰ã® state æ›´æ–°ï¼ˆ**[https://ja.react.dev/reference/react/useCallback#updating-state-from-a-memoized-callback](https://ja.react.dev/reference/react/useCallback#updating-state-from-a-memoized-callback)**ï¼‰**

- ä¸‹è¨˜ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ã€todosã‚’ä¾å­˜å€¤ã¨ã—ã¦æŒ‡å®šã—ã¦ã„ã‚‹

```typescript
function TodoList() {
  const [todos, setTodos] = useState([]);

  const handleAddTodo = useCallback((text) => {
    const newTodo = { id: nextId++, text };
    setTodos([...todos, newTodo]);
  }, [todos]); // todosã‚’ä¾å­˜å€¤ã«æŒ‡å®š
```

- æ›´æ–°ç”¨é–¢æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ä¾å­˜å€¤ã‚’å®Œå…¨ã«ç„¡ãã™ã“ã¨ãŒã§ãã‚‹

```typescript
function TodoList() {
  const [todos, setTodos] = useState([]);

  const handleAddTodo = useCallback((text) => {
    const newTodo = { id: nextId++, text };
    setTodos(todos => [...todos, newTodo]); // æ›´æ–°ç”¨é–¢æ•°
  }, []); // âœ… No need for the todos dependency
  // ...
```


## **ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒé »ç¹ã«ç™ºç«ã™ã‚‹ã®ã‚’é˜²ãÂ ï¼ˆ**[https://ja.react.dev/reference/react/useCallback#preventing-an-effect-from-firing-too-often](https://ja.react.dev/reference/react/useCallback#preventing-an-effect-from-firing-too-often)**ï¼‰**

- `useEffect` å†…ã§ã€é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã„ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€é–¢æ•°ã‚’ä¾å­˜å€¤ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
	- ãŸã ã—ã€ä¾å­˜å€¤ã«è¨­å®šã™ã‚‹ã“ã¨ã§é–¢æ•°ã®ä¸è¦ãªå®Ÿè¡Œã‚’æ‹›ã„ã¦ã—ã¾ã†

		```typescript
		// âŒ Bad
		function ChatRoom({ roomId }) {
		  const [message, setMessage] = useState('');
		
		  function createOptions() {
		    return {
		      serverUrl: 'https://localhost:1234',
		      roomId: roomId
		    };
		  }
		  
		  useEffect(() => {
		    const options = createOptions(); // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«ã€é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã¸ã®å†æ¥ç¶šãŒç¹°ã‚Šè¿”ã•ã‚Œã‚‹ï¼‰
		    const connection = createConnection();
		    connection.connect();
		    return () => connection.disconnect();
		  // é–¢æ•°ã¯ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚Œã‚‹ãŸã³ã«ã€æ–°ã—ãç”Ÿæˆã•ã‚Œã‚‹ï¼ˆå‰å›ã®é–¢æ•°ã¨ã¯åˆ¥ç‰©ï¼‰ãŸã‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹
		  }, [createOptions]); // ğŸ”´ Problem: This dependency changes on every render
		  // ...
		```

- é–¢æ•°ã‚’`useCallback` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€åŒã˜é–¢æ•°ã ã¨ä¿è¨¼ã•ã‚Œã‚‹

	```typescript
	// âœ… Better
	function ChatRoom({ roomId }) {
	  const [message, setMessage] = useState('');
	
	  const createOptions = useCallback(() => {
	    return {
	      serverUrl: 'https://localhost:1234',
	      roomId: roomId
	    };
	  // roomIdãŒåŒã˜å ´åˆã¯ã€createOptionsã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸé–¢æ•°ã‚’è¿”ã™
	  }, [roomId]); // âœ… Only changes when roomId changes
	
	  useEffect(() => {
	    const options = createOptions();
	    const connection = createConnection();
	    connection.connect();
	    return () => connection.disconnect();
	  }, [createOptions]); // âœ… Only changes when createOptions changes
	  // ...
	```

- æœ€ã‚‚è‰¯ã„æ–¹æ³•
	- ä¾å­˜å€¤ã«è¨­å®šã—ãªã„ã“ã¨ â†’ é–¢æ•°ã‚’ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å†…éƒ¨ã¸ç§»å‹•ã™ã‚‹

		```typescript
		// âœ… Best
		function ChatRoom({ roomId }) {
		  const [message, setMessage] = useState('');
		
		  useEffect(() => {
			  // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®å†…éƒ¨ã«ç§»å‹•ã™ã‚‹ã“ã¨ã§ã€ä¾å­˜å€¤ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒãªããªã‚‹
		    function createOptions() { // âœ… No need for useCallback or function dependencies!
		      return {
		        serverUrl: 'https://localhost:1234',
		        roomId: roomId
		      };
		    }
		
		    const options = createOptions();
		    const connection = createConnection();
		    connection.connect();
		    return () => connection.disconnect();
		  }, [roomId]); // âœ… Only changes when roomId changes
		  // ...
		```


## **ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®æœ€é©åŒ–ï¼ˆ**[https://ja.react.dev/reference/react/useCallback#optimizing-a-custom-hook](https://ja.react.dev/reference/react/useCallback#optimizing-a-custom-hook)**ï¼‰**


> ã‚ãªãŸãŒ[ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯](https://ja.react.dev/learn/reusing-logic-with-custom-hooks)ã‚’æ›¸ã„ã¦ã„ã‚‹å ´åˆã€ãã‚ŒãŒè¿”ã™ã‚ã‚‰ã‚†ã‚‹é–¢æ•°ã¯ `useCallback` ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚

